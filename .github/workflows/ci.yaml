name: ci

on:
  pull_request:
  push:
    branches:
      - master
  release:
    types: [created]

jobs:

  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - odoo_version: "master"
            ci_test: false
          - odoo_version: "14.0"
            ci_test: true
          - odoo_version: "13.0"
            ci_test: true
          - odoo_version: "12.0"
            ci_test: false
          - odoo_version: "11.0"
            ci_test: false
          - odoo_version: "10.0"
            ci_test: false
          - odoo_version: "9.0"
            ci_test: false
          - odoo_version: "8.0"
            ci_test: false

    env:
      DOCKER_REPO: odoo-it/docker-odoo
      DOCKER_TAG: ${{ matrix.odoo_version }}
      GIT_SHA1: ${{ github.sha }}
      RELEASE: ${{ github.event.release.tag_name }}
      # Config
      CI_TEST: ${{ matrix.ci_test }}
      CI_PUSH: ${{ github.repository == 'odoo-it/docker-odoo' && github.ref == 'refs/heads/master' }}

    steps:
        # Prepare
      - name: Checkout
        uses: actions/checkout@v2
        # Setup Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
        # Login ghcr.io
      - name: Login to ghcr.io
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
        # Build image
      - name: Build image
        uses: docker/build-push-action@v2
        with:
          file: ${{ env.DOCKER_TAG }}.Dockerfile
          build-args: |
            GIT_SHA1=${{ env.GIT_SHA1 }}
            DOCKER_TAG=${{ env.DOCKER_TAG }}
            DOCKER_REPO=${{ env.DOCKER_REPO }}
            ODOO_VERSION=${{ env.DOCKER_TAG }}
          tags: |
            ${{ env.DOCKER_REPO }}:${{ env.DOCKER_TAG }}
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
          cache-from: type=registry,ref=ghcr.io/${{ env.DOCKER_REPO }}:${{ env.DOCKER_TAG }}
          cache-to: type=local,dest=/tmp/.buildx-cache
          load: true
        # Test
      - name: Run tests
        if: env.CI_TEST == 'true' || env.CI_TEST == '1'
        run: |
          docker-compose -f tests/docker-compose.yml build
          docker-compose -f tests/docker-compose.yml run --rm odoo odoo --init=all --test-enable --stop-after-init
        # Push to Github Packages
      - name: Push to Github Packages
        if: env.CI_PUSH == 'true'
        run: hooks/push
        env:
          REGISTRY_HOST: ghcr.io
          REGISTRY_USERNAME: ${{ github.repository_owner }}
          REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
